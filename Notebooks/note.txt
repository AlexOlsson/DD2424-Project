The code is not pretty but works fine :)
